# CLAUDE.md

## プロジェクト概要

Web Audio APIを使用した高機能メトロノームアプリケーション。ブラウザ上で動作し、完全無料で使用可能。

## 技術スタック

- **HTML5**: セマンティックなマークアップ
- **CSS3**: レスポンシブデザイン、アニメーション、ライト/ダークモード
- **JavaScript (ES6+)**: クラスベースの設計、Web Audio API
- **Web Audio API**: 高精度なタイミング制御とオーディオ生成
- **localStorage**: 設定とカスタムプリセットの永続化

## 主要機能

### 基本機能
- **テンポ設定**: 1〜300 BPMまで対応
- **拍子設定**: 1〜8拍まで選択可能
- **音色**: 4種類（クリック、ビープ、ウッド、カウベル）
- **リズムパターン**: シンプル、8分音符、3連符、16分音符、6連符
- **音量調整**: 0〜100%まで調整可能

### ビジュアル機能
- **振り子アニメーション**: 古典的なメトロノームの動きを再現
- **パルスアニメーション**: BPM表示が拍に合わせて拡大縮小
- **点滅アニメーション**: 画面全体が拍に合わせて点滅
- **拍インジケーター**: 現在の拍位置を表示（例: 3/4）

### 便利機能
- **タップテンポ**: ボタンを連打してテンポを直感的に設定
- **プリセット**: よく使われるテンポをワンクリックで設定（Largo, Andante, Moderato, Allegro, Presto）
- **カスタムプリセット**: 現在の設定を保存・読み込み・削除
- **タイマー機能**: 分・秒単位で設定可能、終了時にアラーム音
- **キーボードショートカット**:
  - `Space`: 再生/停止
  - `↑/↓`: テンポ±1（Shift押下で±10）
  - `T`: タップテンポ

### UI/UX機能
- **ダーク/ライトモード**: トグルスイッチで切り替え
- **多言語対応**: 日本語/英語の切り替え
- **レスポンシブデザイン**: スマートフォンからデスクトップまで対応
- **設定の永続化**: ページを閉じても設定が保持される

## アーキテクチャ

### クラス設計

#### Metronome クラス
メトロノームの核となるロジックを管理。

**主要メソッド:**
- `start()`: メトロノーム開始（即座に1拍目を再生）
- `stop()`: メトロノーム停止
- `scheduler()`: Web Audio APIのスケジューラー（25msごとに実行）
- `scheduleNote()`: 音とビジュアルのスケジューリング
- `playSound()`: Web Audio APIによる音生成
- `updateVisuals()`: 振り子などのビジュアル更新
- `handleTap()`: タップテンポの計算

#### ThemeManager クラス
ダーク/ライトモードの切り替えを管理。

#### LanguageManager クラス
日本語/英語の翻訳を管理。data-i18n属性を使用した自動翻訳。

### データフロー

1. **初期化**: `DOMContentLoaded`イベントで各クラスをインスタンス化
2. **設定読み込み**: localStorageから保存済み設定を読み込み
3. **ユーザー操作**: イベントリスナーで各種操作を処理
4. **スケジューリング**: Web Audio APIのcurrentTimeと比較して先読みスケジューリング
5. **ビジュアル更新**: setTimeout()で音の再生タイミングに合わせて更新
6. **設定保存**: 変更時に自動的にlocalStorageへ保存

## Web Audio API実装の詳細

### タイミング制御
- `audioContext.currentTime`: 高精度な現在時刻
- `scheduleAheadTime`: 0.1秒先まで先読みスケジューリング
- `scheduler()`: 25msごとに実行し、必要な音を先読みスケジュール

### 音生成
- `OscillatorNode`: 周波数を指定して音を生成
- `GainNode`: 音量とエンベロープ制御
- エンベロープ: `exponentialRampToValueAtTime()`でフェードアウト

### 即座スタートの実装
スタートボタンを押した瞬間に1拍目が鳴るよう、以下の処理を実施：
1. 手動で`playSound()`と`updateVisuals()`を即座に実行
2. `nextNoteTime`を1拍分進める
3. `currentBeat`を1に設定し、次のスケジューラーサイクルで2拍目から続く

## 振り子アニメーションの実装

### グローバル拍カウンター
- `totalBeats`: 小節をまたいでも連続でカウント
- 偶数（0, 2, 4...）→ 左側（-30deg）
- 奇数（1, 3, 5...）→ 右側（30deg）

### トランジション
- `transition: transform ${beatDuration}s linear`
- 拍の長さ（60/BPM秒）に合わせてスムーズに動く

### アクセント表示
- 1拍目（アクセント）時に振り子の球が赤く点滅
- ダーク/ライトモード両対応

## 開発の経緯と主要な修正履歴

### 初期実装
- 基本的なメトロノーム機能
- ダーク/ライトモードトグル
- 日本語/英語切り替え

### タイマー機能追加
- 分・秒単位の入力
- カウントダウン表示
- 終了時のアラーム音（3回）
- 右カラムへのレイアウト配置

### UI改善
- トグルスイッチとタイマーが反応しない問題を修正（HTML構造の修正）
- languageManager初期化順序の問題を解決
- コンテナ幅を800pxから1400pxに拡大

### 振り子アニメーション改善
- スタートボタン押下時に即座に動くよう修正
- 最初の拍で動かない問題を複数回修正
- 2拍目が即座に鳴る問題を解決（nextNote()の呼び出しを削除）

### UI微調整
- スタートボタンのサイズ変更問題を修正（min-width/min-height設定）
- プリセットパネルの表記変更（「保存したプリセット」→「プリセット」）
- リネーム機能の削除
- 拍子とリズムパターンを横並びに配置
- セパレート線の削除

### ライトモード改善
- 振り子のアクセント時（1拍目）に赤く表示されるよう修正

## ファイル構成

```
metronome/
├── index.html       # メインHTML、3カラムレイアウト（プリセット/メイン/タイマー）
├── style.css        # スタイルシート、ダーク/ライトモード対応
├── script.js        # メトロノーム機能、Web Audio API実装
├── README.md        # ユーザー向けドキュメント
└── CLAUDE.md        # 開発者向けドキュメント（このファイル）
```

## ブラウザ対応

- Chrome / Edge（推奨）
- Firefox
- Safari
- Opera

※ Web Audio APIをサポートする最新のブラウザで動作

## 既知の制限事項

- Web Audio APIの制限により、初回再生時はユーザーインタラクション（ボタンクリックなど）が必要
- ブラウザタブがバックグラウンドになると、タイミングの精度がやや低下する可能性がある
- 非常に高速なテンポ（250+ BPM）では、ブラウザのパフォーマンスに依存する

## 今後の拡張案

- [ ] オーディオファイルのカスタム音色サポート
- [ ] メトロノームのビート強弱パターンのカスタマイズ
- [ ] MIDI出力サポート
- [ ] 複合拍子のサポート（5/8, 7/8など）
- [ ] プリセットのエクスポート/インポート機能
- [ ] PWA対応（オフラインでの完全動作）

## ライセンス

MIT License

## 作者

Created with Claude Code by Anthropic

## 開発メモ

### Web Audio APIのベストプラクティス
- スケジューリングは先読み方式（look-ahead scheduling）を採用
- UIスレッドとオーディオスレッドを分離
- `currentTime`ベースの絶対時間管理

### パフォーマンス最適化
- DOMの更新を最小限に抑える
- CSSトランジションを活用（JavaScriptアニメーションより効率的）
- localStorageへの書き込みを必要最小限に

### アクセシビリティ
- キーボードショートカット対応
- 視覚的フィードバック（振り子、点滅、パルス）
- 明確なラベルとボタン配置
