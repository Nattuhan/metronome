# CLAUDE.md

## プロジェクト概要

Web Audio APIを使用した高機能メトロノームアプリケーション。ブラウザ上で動作し、完全無料で使用可能。

## 技術スタック

- **HTML5**: セマンティックなマークアップ
- **CSS3**: レスポンシブデザイン、アニメーション、ライト/ダークモード
- **JavaScript (ES6+)**: クラスベースの設計、Web Audio API
- **Web Audio API**: 高精度なタイミング制御とオーディオ生成
- **localStorage**: 設定とカスタムプリセットの永続化

## 主要機能

### 基本機能
- **テンポ設定**: 1〜300 BPMまで対応
- **拍子設定**: 1〜8拍まで選択可能
- **音色**: 4種類（クリック、ビープ、ウッド、カウベル）
- **リズムパターン**: シンプル、8分音符、3連符、16分音符、6連符
- **音量調整**: 0〜100%まで調整可能

### ビジュアル機能
- **振り子アニメーション**: 古典的なメトロノームの動きを再現
- **パルスアニメーション**: BPM表示が拍に合わせて拡大縮小
- **点滅アニメーション**: 画面全体が拍に合わせて点滅
- **拍インジケーター**: 現在の拍位置を表示（例: 3/4）

### 便利機能
- **タップテンポ**: ボタンを連打してテンポを直感的に設定
- **プリセット**: よく使われるテンポをワンクリックで設定（Largo, Andante, Moderato, Allegro, Presto）
- **カスタムプリセット**: 現在の設定を保存・読み込み・削除
- **タイマー機能**: 分・秒単位で設定可能、終了時にアラーム音
- **キーボードショートカット**:
  - `Space`: 再生/停止
  - `↑/↓`: テンポ±1（Shift押下で±10）
  - `T`: タップテンポ

### UI/UX機能
- **ダーク/ライトモード**: トグルスイッチで切り替え
- **多言語対応**: 日本語/英語の切り替え
- **レスポンシブデザイン**: スマートフォンからデスクトップまで対応
- **設定の永続化**: ページを閉じても設定が保持される

### 音楽解析機能
- **ファイルアップロード**: ドラッグ&ドロップ対応の音楽ファイル読み込み
- **BPM自動検出**: 複素正弦波との相関による高精度BPM検出アルゴリズム
- **波形表示**: 標準的な縦線スタイルの波形ビジュアライザー
- **波形ドラッグ選択**: ドラッグで範囲を選択してループ再生
- **シーク機能**: 波形クリックで任意の位置へジャンプ
- **メトロノーム同期**: 曲の再生位置に合わせてメトロノームが同期

## アーキテクチャ

### クラス設計

#### Metronome クラス
メトロノームの核となるロジックを管理。

**主要メソッド:**
- `start()`: メトロノーム開始（即座に1拍目を再生）
- `stop()`: メトロノーム停止
- `scheduler()`: Web Audio APIのスケジューラー（25msごとに実行）
- `scheduleNote()`: 音とビジュアルのスケジューリング
- `playSound()`: Web Audio APIによる音生成
- `updateVisuals()`: 振り子などのビジュアル更新
- `handleTap()`: タップテンポの計算

#### ThemeManager クラス
ダーク/ライトモードの切り替えを管理。

#### LanguageManager クラス
日本語/英語の翻訳を管理。data-i18n属性を使用した自動翻訳。

#### MusicAnalyzer クラス
音楽ファイルの解析と再生を管理。

**主要メソッド:**
- `loadAudioFile()`: 音楽ファイルを読み込み、デコード
- `detectBPM()`: 複素正弦波との相関によるBPM検出（2段階探索：粗い探索→細かい探索）
- `detectFirstBeat()`: 最初の音の開始位置を検出（シンプルな閾値ベース）
- `shiftBeatOffset()`: 拍位置を半拍分ずらす（裏拍対応）
- `playMusic()` / `stopMusic()`: 音楽の再生・停止
- `seekTo()`: 任意の位置へシーク
- `drawWaveform()`: 標準的な波形表示（min/max方式）
- `updateSelectionDisplay()`: ドラッグ選択範囲の視覚表示
- `checkLoop()`: ループ範囲の監視と自動シーク

### データフロー

1. **初期化**: `DOMContentLoaded`イベントで各クラスをインスタンス化
2. **設定読み込み**: localStorageから保存済み設定を読み込み
3. **ユーザー操作**: イベントリスナーで各種操作を処理
4. **スケジューリング**: Web Audio APIのcurrentTimeと比較して先読みスケジューリング
5. **ビジュアル更新**: setTimeout()で音の再生タイミングに合わせて更新
6. **設定保存**: 変更時に自動的にlocalStorageへ保存

## Web Audio API実装の詳細

### タイミング制御
- `audioContext.currentTime`: 高精度な現在時刻
- `scheduleAheadTime`: 0.1秒先まで先読みスケジューリング
- `scheduler()`: 25msごとに実行し、必要な音を先読みスケジュール

### 音生成
- `OscillatorNode`: 周波数を指定して音を生成
- `GainNode`: 音量とエンベロープ制御
- エンベロープ: `exponentialRampToValueAtTime()`でフェードアウト

### 即座スタートの実装
スタートボタンを押した瞬間に1拍目が鳴るよう、以下の処理を実施：
1. 手動で`playSound()`と`updateVisuals()`を即座に実行
2. `nextNoteTime`を1拍分進める
3. `currentBeat`を1に設定し、次のスケジューラーサイクルで2拍目から続く

## 振り子アニメーションの実装

### グローバル拍カウンター
- `totalBeats`: 小節をまたいでも連続でカウント
- 偶数（0, 2, 4...）→ 左側（-30deg）
- 奇数（1, 3, 5...）→ 右側（30deg）

### トランジション
- `transition: transform ${beatDuration}s linear`
- 拍の長さ（60/BPM秒）に合わせてスムーズに動く

### アクセント表示
- 1拍目（アクセント）時に振り子の球が赤く点滅
- ダーク/ライトモード両対応

## 開発の経緯と主要な修正履歴

### 初期実装
- 基本的なメトロノーム機能
- ダーク/ライトモードトグル
- 日本語/英語切り替え

### タイマー機能追加
- 分・秒単位の入力
- カウントダウン表示
- 終了時のアラーム音（3回）
- 右カラムへのレイアウト配置

### UI改善
- トグルスイッチとタイマーが反応しない問題を修正（HTML構造の修正）
- languageManager初期化順序の問題を解決
- コンテナ幅を800pxから1400pxに拡大

### 振り子アニメーション改善
- スタートボタン押下時に即座に動くよう修正
- 最初の拍で動かない問題を複数回修正
- 2拍目が即座に鳴る問題を解決（nextNote()の呼び出しを削除）

### UI微調整
- スタートボタンのサイズ変更問題を修正（min-width/min-height設定）
- プリセットパネルの表記変更（「保存したプリセット」→「プリセット」）
- リネーム機能の削除
- 拍子とリズムパターンを横並びに配置
- セパレート線の削除

### ライトモード改善
- 振り子のアクセント時（1拍目）に赤く表示されるよう修正

### 音楽解析機能の実装
- BPM自動検出アルゴリズムの実装
  - 複素正弦波との相関による検出
  - 2段階探索（粗い探索0.1刻み → 細かい探索0.01刻み）
  - オクターブエラー補正（100 BPM未満の場合は2倍も検討）
- 波形表示の改善
  - 最初はポリゴン方式で「ぐちゃぐちゃ」だった波形を標準的な縦線スタイルに変更
  - 各ピクセルでmin/maxを計算して縦線を描画
  - 高DPI対応（devicePixelRatio）
- 波形ドラッグ選択によるループ再生機能
  - マウスドラッグで範囲を選択
  - 選択範囲を青い半透明オーバーレイで表示
  - 選択範囲を自動ループ再生
  - ドラッグ距離5px未満はクリック判定でシーク
- 音楽停止時の動作改善
  - 停止したら次回再生時は最初から再生（resume機能を削除）

### 拍位置調整機能の追加（最新）
- **拍位置を半拍ずらすボタン**の追加
  - 裏拍で始まる曲（千本桜など）に対応するため、手動で拍位置を調整できる機能を追加
  - ボタンをクリックすると `firstBeatOffset` が半拍分（0.5拍）ずつシフト
  - 再生中でも即座にメトロノームの同期を再調整
  - 音楽解析パネルの同期コントロール内に配置
- **拍位置検出ロジックのシンプル化**
  - 複雑なエネルギーエンベロープのピーク検出を削除
  - シンプルな閾値ベースの検出に戻した（`detectFirstBeat()`）
  - アルゴリズムによる自動検出よりも、ユーザーの手動調整を優先する設計に変更

### ファイル構造のリファクタリング（最新）
- モノリシックな1800行のscript.jsを複数ファイルに分割
- ES6モジュールによるクラス分離
- 保守性とコードの可読性が大幅に向上

## ファイル構成

```
metronome/
├── index.html              # メインHTML、3カラムレイアウト（プリセット/メイン/タイマー・音楽解析）
├── style.css               # スタイルシート、ダーク/ライトモード対応
├── js/
│   ├── main.js             # アプリケーション初期化（ES6モジュール）
│   ├── metronome.js        # Metronomeクラス（約900行）
│   ├── theme-manager.js    # ThemeManagerクラス（約35行）
│   ├── language-manager.js # LanguageManagerクラス（約180行）
│   └── music-analyzer.js   # MusicAnalyzerクラス（約790行）
├── README.md               # ユーザー向けドキュメント
├── CLAUDE.md               # 開発者向けドキュメント（このファイル）
└── .gitignore              # /.claude/を無視
```

### モジュール構成

各JavaScriptファイルはES6モジュールとして実装され、`main.js`で統合されます：

```javascript
// main.js
import { Metronome } from './metronome.js';
import { ThemeManager } from './theme-manager.js';
import { LanguageManager } from './language-manager.js';
import { MusicAnalyzer } from './music-analyzer.js';
```

## ブラウザ対応

- Chrome / Edge（推奨）
- Firefox
- Safari
- Opera

※ Web Audio APIをサポートする最新のブラウザで動作

## ローカルでの実行方法

ES6モジュールを使用しているため、`file://`プロトコルでは動作しません。ローカルHTTPサーバーが必要です。

### 方法1: Pythonを使う
```bash
python -m http.server 8000
# http://localhost:8000 でアクセス
```

### 方法2: Node.jsを使う
```bash
npx http-server -p 8000
# http://localhost:8000 でアクセス
```

### 方法3: VS Code Live Server
VS Codeの拡張機能「Live Server」をインストールし、index.htmlを右クリック→「Open with Live Server」

## 既知の制限事項

- Web Audio APIの制限により、初回再生時はユーザーインタラクション（ボタンクリックなど）が必要
- ブラウザタブがバックグラウンドになると、タイミングの精度がやや低下する可能性がある
- 非常に高速なテンポ（250+ BPM）では、ブラウザのパフォーマンスに依存する

## 今後の拡張案

### 既存機能の拡張
- [ ] オーディオファイルのカスタム音色サポート
- [ ] メトロノームのビート強弱パターンのカスタマイズ
- [ ] MIDI出力サポート
- [ ] 複合拍子のサポート（5/8, 7/8など）
- [ ] プリセットのエクスポート/インポート機能
- [ ] PWA対応（オフラインでの完全動作）

### 音楽解析機能の拡張

#### フェーズ1: 曲アップロード＆BPM検出・同期 ★実装済み ✓
**実装済み機能**:
- [x] ファイルアップロードUIの追加
  - [x] HTMLに`<input type="file" accept="audio/*">`を追加
  - [x] ドラッグ&ドロップ対応
  - [x] アップロードファイルの視覚的フィードバック
- [x] Web Audio APIによるオーディオデコード
  - [x] FileReader APIでファイル読み込み
  - [x] `audioContext.decodeAudioData()`で音声データ化
  - [x] エラーハンドリング（非対応フォーマット、大きすぎるファイル等）
- [x] BPM検出機能の実装
  - [x] 独自の複素正弦波相関アルゴリズム実装（ライブラリ不使用）
  - [x] 2段階探索による高精度検出（粗い探索→細かい探索）
  - [x] オクターブエラー補正（100 BPM未満の場合は2倍も検討）
  - [x] 検出されたBPMをテンポスライダーに自動反映
- [x] 曲とメトロノームの同期再生
  - [x] 音楽再生コントロール（再生/停止/削除）
  - [x] メトロノームと曲のタイミング同期
  - [x] 視覚的な同期表示（波形上の再生線）
- [x] UI配置
  - [x] 右カラムに音楽解析パネルを配置
  - [x] 再生波形の視覚化（標準的な縦線スタイル）
- [x] 波形インタラクション
  - [x] ドラッグで範囲選択してループ再生
  - [x] クリックでシーク
  - [x] 選択範囲の視覚表示

**未実装の改善案**:
- [ ] 複数のBPM候補を表示して選択可能にする
- [ ] ビート位置の視覚的ハイライト（波形上にビートマーカー表示）
- [ ] テンポ変化（accelerando/ritardando）の検出

#### フェーズ2: キー（調）とスケール検出 ★優先度：中
**目的**: アップロードした曲のキーとスケール（メジャー/マイナー）を自動検出

**実装タスク**:
- [ ] クロマグラム解析の実装
  - [ ] FFTによる周波数解析（Web Audio API内蔵）
  - [ ] 12音階（C, C#, D...）の出現頻度計算
- [ ] キー検出アルゴリズム
  - [ ] Krumhansl-Schmuckler algorithmの実装
  - [ ] メジャー/マイナースケールの判定
  - [ ] 信頼度スコアの計算
- [ ] 検出結果の表示UI
  - [ ] 検出されたキーを表示（例: "C Major", "A Minor"）
  - [ ] スケール音の視覚化（ピアノロール風表示）
  - [ ] 推奨される練習スケールの提示
- [ ] 転調検出（高度な機能）
  - [ ] 時系列でのキー変化追跡
  - [ ] セクションごとのキー表示

**技術スタック**:
- Meyda.js（chroma機能）
- 音楽理論アルゴリズム
- 推定工数: 2-3日

#### フェーズ3: コード進行解析 ★優先度：低（高難度）
**目的**: 時系列でのコード進行を自動検出・表示

**実装タスク**:
- [ ] 和音認識アルゴリズムの実装
  - [ ] 時間窓ごとのクロマグラム計算
  - [ ] 和音テンプレートマッチング
  - [ ] メジャー/マイナー/7th/dim/aug等の判定
- [ ] コード進行の表示UI
  - [ ] タイムライン上にコード名を表示
  - [ ] 曲の再生位置と同期したハイライト
  - [ ] コード進行のエクスポート機能（テキスト形式）
- [ ] 精度向上の工夫
  - [ ] 機械学習モデルの導入検討（Magenta.js）
  - [ ] ユーザーによる手動修正機能
  - [ ] 倍音・ノイズ除去フィルター

**技術スタック**:
- Meyda.js / Essentia.js
- ml5.js + Magenta（機械学習ベース、オプション）
- 推定工数: 4-5日
- **注意**: 精度は限定的になる可能性が高い

#### 共通の技術課題
- [ ] パフォーマンス最適化
  - [ ] Web Workerで重い計算をバックグラウンド処理
  - [ ] 大きなファイルの段階的読み込み
  - [ ] プログレスバー表示
- [ ] ブラウザ互換性
  - [ ] Chrome/Edge: 完全サポート
  - [ ] Firefox/Safari: 一部機能制限の可能性
- [ ] ユーザーエクスペリエンス
  - [ ] 処理中のローディング表示
  - [ ] エラーメッセージの分かりやすい表示
  - [ ] チュートリアル・ヘルプ機能

## ライセンス

MIT License

## 作者

Created with Claude Code by Anthropic

## 開発メモ

### Web Audio APIのベストプラクティス
- スケジューリングは先読み方式（look-ahead scheduling）を採用
- UIスレッドとオーディオスレッドを分離
- `currentTime`ベースの絶対時間管理

### パフォーマンス最適化
- DOMの更新を最小限に抑える
- CSSトランジションを活用（JavaScriptアニメーションより効率的）
- localStorageへの書き込みを必要最小限に
- ES6モジュールによる遅延読み込み

### コード構成原則
- SOLID原則に基づいたクラス分離
- 単一責任の原則：各クラスは1つの責務のみを持つ
- ファイルサイズの目安：1ファイル1000行以下を目標
- ES6モジュールによる依存関係の明確化

### アクセシビリティ
- キーボードショートカット対応
- 視覚的フィードバック（振り子、点滅、パルス）
- 明確なラベルとボタン配置

## 開発ワークフロー

### Git操作
- ファイルを編集したら必ずコミットとプッシュを行うこと
- GitHub CLIを使用してGitHub関連の操作を実行すること
- コミットメッセージは変更内容を明確に記述すること
